{% extends "publisher_base.html" %}

{% block title %}Withdraw Funds{% endblock %}

{% block mobile_title %}Withdraw Funds{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <h1 class="hidden lg:block text-3xl font-bold text-gray-800 mb-8">Withdraw Funds</h1>
    
    <!-- Balance Card -->
    <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90 mb-2">Available Balance</p>
                <p class="text-5xl font-bold">${{ "%.2f"|format(balance) }}</p>
                <p class="text-sm opacity-75 mt-3">Minimum withdrawal: ${{ "%.2f"|format(minimum_withdrawal) }}</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Bank Account Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Bank Account Details</h2>
        
        {% if bank_account %}
        <div class="bg-gray-50 rounded-xl p-6 mb-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-sm text-gray-600 mb-4">Current Bank Account</p>
                    <div class="space-y-2">
                        <p class="text-lg font-semibold text-gray-800">{{ bank_account.account_holder_name }}</p>
                        <p class="text-gray-600">{{ bank_account.bank_name }}</p>
                        <p class="text-gray-600">Account: ****{{ bank_account.account_number[-4:] }}</p>
                        <p class="text-gray-600">{{ bank_account.country }}</p>
                    </div>
                </div>
                <button onclick="toggleBankForm()" class="text-cyan-600 hover:text-cyan-700 font-medium text-sm">
                    Update
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
            <p class="text-yellow-800">Please add your bank account details to request withdrawals.</p>
        </div>
        {% endif %}

        <form id="bankForm" class="{% if bank_account %}hidden{% endif %}" method="POST" action="/publisher/save-bank-account">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Account Holder Name</label>
                    <input type="text" name="account_holder_name" value="{{ bank_account.account_holder_name if bank_account else '' }}" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Bank Name</label>
                    <input type="text" name="bank_name" value="{{ bank_account.bank_name if bank_account else '' }}" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Account Number</label>
                    <input type="text" name="account_number" value="{{ bank_account.account_number if bank_account else '' }}" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Routing Number (Optional)</label>
                    <input type="text" name="routing_number" value="{{ bank_account.routing_number if bank_account else '' }}" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">SWIFT/BIC Code (Optional)</label>
                    <input type="text" name="swift_code" value="{{ bank_account.swift_code if bank_account else '' }}" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Country</label>
                    <input type="text" name="country" value="{{ bank_account.country if bank_account else '' }}" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button type="submit" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-xl transition duration-200">
                    Save Bank Account
                </button>
                {% if bank_account %}
                <button type="button" onclick="toggleBankForm()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition duration-200">
                    Cancel
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Withdrawal Request Section -->
    {% if bank_account %}
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Request Withdrawal</h2>
        
        <form id="withdrawalForm" method="POST" action="/publisher/request-withdrawal">
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Withdrawal Amount (USD)</label>
                <input type="number" name="amount" step="0.01" min="{{ minimum_withdrawal }}" max="{{ balance }}" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500"
                       placeholder="Enter amount">
                <p class="text-xs text-gray-500 mt-2">Available balance: ${{ "%.2f"|format(balance) }}</p>
            </div>
            <button type="submit" class="px-8 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition duration-200">
                Request Withdrawal
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Withdrawal History -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Withdrawal History</h2>
        
        {% if withdrawals %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Date</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Amount</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for withdrawal in withdrawals %}
                    <tr class="border-b border-gray-100">
                        <td class="py-4 px-4 text-gray-600">{{ withdrawal.requested_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="py-4 px-4 font-semibold text-gray-800">${{ "%.2f"|format(withdrawal.amount) }}</td>
                        <td class="py-4 px-4">
                            {% if withdrawal.status == 'pending' %}
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">Pending</span>
                            {% elif withdrawal.status == 'approved' %}
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Approved</span>
                            {% elif withdrawal.status == 'rejected' %}
                            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">Rejected</span>
                            {% elif withdrawal.status == 'completed' %}
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">Completed</span>
                            {% endif %}
                        </td>
                        <td class="py-4 px-4 text-gray-600 text-sm">{{ withdrawal.admin_note or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 text-center py-8">No withdrawal history yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function toggleBankForm() {
        const form = document.getElementById('bankForm');
        form.classList.toggle('hidden');
    }

    {% if message %}
    alert('{{ message }}');
    {% endif %}
</script>
{% endblock %}
